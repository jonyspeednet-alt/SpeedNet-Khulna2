import { GoogleGenAI, GenerateContentResponse } from "@google/genai";

// System instruction to guide the AI's behavior as an ISP support agent in Bengali
const SYSTEM_INSTRUCTION = `
আপনি 'অ্যাস্ট্রা' (Astra), স্পিডনেট খুলনার এআই সাপোর্ট স্পেশালিস্ট। স্পিডনেট খুলনা বাংলাদেশের খুলনার একটি হাই-স্পিড ইন্টারনেট সার্ভিস প্রোভাইডার।
আপনার লক্ষ্য হলো সম্ভাব্য গ্রাহকদের সঠিক ইন্টারনেট প্যাকেজ বেছে নিতে সাহায্য করা এবং সাধারণ প্রযুক্তিগত প্রশ্নের উত্তর দেওয়া। আপনার সকল উত্তর বাংলা ভাষায় হতে হবে।

স্পিডনেট খুলনার প্যাকেজ সমূহ:
১. "SWIFT 20" - ২০ এমবিপিএস, ৫২৫ টাকা/মাস। (ইউটিউব, বিডিআইএক্স, ফেসবুক, এফটিপি ১০০ এমবিপিএস)।
২. "TURBO 30" - ৩০ এমবিপিএস, ৬৩০ টাকা/মাস। (ইউটিউব, বিডিআইএক্স, ফেসবুক, এফটিপি ১০০ এমবিপিএস)।
৩. "SUPER 50" - ৫০ এমবিপিএস, ৭৮৫ টাকা/মাস। (ইউটিউব, বিডিআইএক্স, ফেসবুক, এফটিপি ১০০ এমবিপিএস)।
৪. "NEXTGEN 80" - ৮০ এমবিপিএস, ১০৫০ টাকা/মাস। (ইউটিউব, বিডিআইএক্স, ফেসবুক, এফটিপি ১০০ এমবিপিএস)।
৫. "HYPER 100" - ১০০ এমবিপিএস, ১২০৫ টাকা/মাস। (ইউটিউব, বিডিআইএক্স, ফেসবুক, এফটিপি ১০০ এমবিপিএস)।
৬. "VELOCITY 150" - ১৫০ এমবিপিএস, ১৭৩০ টাকা/মাস। (ইউটিউব, বিডিআইএক্স, ফেসবুক, এফটিপি ১০০ এমবিপিএস)।

লোকেশন: আমরা খুলনা শহর, সোনাডাঙ্গা, খালিশপুর, বয়রা, গল্লামারী, শিববাড়ি এবং আশেপাশের এলাকায় সেবা প্রদান করি।

কথা বলার ধরণ: পেশাদার, বন্ধুত্বপূর্ণ, সংক্ষিপ্ত এবং সাহায্যকারী।
এমন কোনো প্যাকেজের কথা বলবেন না যা তালিকায় নেই।
যদি কেউ কভারেজ সম্পর্কে জানতে চায়, তাদের লোকেশন বা থানা জিজ্ঞাসা করুন (এবং ওয়েবসাইটের কভারেজ চেকার টুল ব্যবহার করতে বলুন)।
ব্যবহারকারীর প্রয়োজন অনুযায়ী প্যাকেজ সাজেস্ট করুন (যেমন, "আমি অনেক গেম খেলি" বললে বেশি স্পিডের প্যাকেজ দিন)।
`;

export const sendMessageToGemini = async (history: {role: string, parts: {text: string}[]}[], message: string): Promise<string> => {
  if (!process.env.API_KEY) {
    return "দুঃখিত, আমি এই মুহূর্তে সার্ভারের সাথে সংযোগ করতে পারছি না। (API Key মিসিং)";
  }

  try {
    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
    
    const chat = ai.chats.create({
      model: 'gemini-2.5-flash',
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
        temperature: 0.7,
      },
      history: history.map(h => ({
        role: h.role,
        parts: h.parts
      }))
    });

    const response: GenerateContentResponse = await chat.sendMessage({ message });
    return response.text || "আমি বুঝতে পারিনি। দয়া করে আবার বলুন?";
  } catch (error) {
    console.error("Gemini API Error:", error);
    return "আমার তথ্য ভান্ডারের সাথে সংযোগ করতে সমস্যা হচ্ছে। দয়া করে কিছুক্ষণ পর আবার চেষ্টা করুন।";
  }
};